<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Organiser Dashboard</title>
  <link rel="stylesheet" href="/main.css" />
</head>
<body>
  <%  
    // Helpers for formatting
    function formatDate(iso) {
      const [y,m,d] = iso.split('T')[0].split('-');
      return `${d}/${m}/${y}`;
    }
    function formatDateTime(iso) {
      const dt = new Date(iso);
      const d  = String(dt.getDate()).padStart(2,'0');
      const m  = String(dt.getMonth()+1).padStart(2,'0');
      const y  = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2,'0');
      const mm = String(dt.getMinutes()).padStart(2,'0');
      return `${d}/${m}/${y} ${hh}:${mm}`;
    }
  %>

  <!-- Header -->
  <header>
    <h1><%= siteSettings.name %></h1>
    <p><%= siteSettings.description %></p>
    <nav>
      <a href="/organiser/settings">Site Settings</a>
      <!-- now GETs the blank form -->
      <a href="/organiser/events/new" style="margin-left:1rem;">Create New Event</a>
    </nav>
  </header>

  <!-- Published Events -->
  <section>
    <h2>Published Events</h2>
    <ul>
      <% publishedEvents.forEach(ev => { %>
        <li>
          <h3><%= ev.title %></h3>
          <p><strong>Event Date:</strong> <%= formatDate(ev.date) %></p>
          <p><strong>Created On:</strong> <%= formatDateTime(ev.created_at) %></p>
          <p><strong>Published On:</strong> <%= formatDateTime(ev.published_at) %></p>
          <p><strong>Total tickets:</strong> <%= ev.total_qty %></p>
          <p><strong>Sold:</strong> <%= ev.sold_total %>
             (Full: <%= ev.sold_full %>, Concession: <%= ev.sold_conc %>)</p>
          <form action="/attendee/events/<%= ev.id %>" method="GET" style="display:inline; margin-right:1rem;">
            <button type="submit">View as Attendee</button>
          </form>
          <a href="/organiser/events/<%= ev.id %>/edit" style="margin-right:1rem;">Edit</a>
          <form action="/organiser/events/<%= ev.id %>/delete" method="POST" style="display:inline;">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
      <% if (!publishedEvents.length) { %>
        <li>No published events yet.</li>
      <% } %>
    </ul>
  </section>

  <!-- Draft Events -->
  <section>
    <h2>Draft Events</h2>
    <ul>
      <% draftEvents.forEach(ev => { %>
        <li>
          <h3><%= ev.title || 'Untitled' %></h3>
          <p><strong>Event Date:</strong> <%= formatDate(ev.date) %></p>
          <p><strong>Created On:</strong> <%= formatDateTime(ev.created_at) %></p>
          <p><strong>Total tickets:</strong> <%= ev.total_qty %></p>
          <p><strong>Sold:</strong> <%= ev.sold_total %>
             (Full: <%= ev.sold_full %>, Concession: <%= ev.sold_conc %>)</p>
          <form action="/attendee/events/<%= ev.id %>" method="GET" style="display:inline; margin-right:1rem;">
            <button type="submit">View as Attendee</button>
          </form>
          <a href="/organiser/events/<%= ev.id %>/edit" style="margin-right:1rem;">Edit</a>
          <form action="/organiser/events/<%= ev.id %>/publish" method="POST" style="display:inline; margin-right:1rem;">
            <button type="submit">Publish</button>
          </form>
          <form action="/organiser/events/<%= ev.id %>/delete" method="POST" style="display:inline;">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
      <% if (!draftEvents.length) { %>
        <li>No drafts available.</li>
      <% } %>
    </ul>
  </section>
</body>
</html>
